---
phase: 02-code-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/figma_context.py
autonomous: true
requirements:
  - CODE-01
must_haves:
  truths:
    - Raw Figma design_context is transformed to compact, LLM-friendly structure
    - Transformer extracts layout, typography, colors, text content, component tree
    - Tree depth is pruned to avoid context overflow
  artifacts:
    - path: backend/app/figma_context.py
      provides: transform_design_context(raw) -> dict
      contains: "transform_design_context"
  key_links:
    - from: backend/app/figma_context.py
      to: Figma nodes/document structure
      via: recursive _flatten_node
      pattern: "nodes|document|absoluteBoundingBox"
---

<objective>
Create design context transformer that converts raw Figma API response to compact, code-ready structure for LLM consumption. Mirrors Figma MCP get_design_context quality.

Purpose: Raw Figma nodes are verbose (100KB+). LLM needs structured, pruned context. Transformer produces layout, typography, fills, text, component tree.
Output: backend/app/figma_context.py with transform_design_context().
</objective>

<execution_context>
@/Users/shubham/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shubham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-code-generation/02-CONTEXT.md
@.planning/phases/02-code-generation/02-RESEARCH.md
@backend/app/api/figma.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create figma_context module</name>
  <files>backend/app/figma_context.py</files>
  <action>
    Create backend/app/figma_context.py with transform_design_context(raw: dict) -> dict.
    Input: raw design_context from FigmaImportResponse (nodes, components, styles).
    Output structure (per 02-RESEARCH.md):
    {
      "frame": { "name": str, "width": int, "height": int },
      "tree": [ { "id", "type", "name", "layout"?, "style"?, "content"?, "children": [...] } ],
      "components": {},  # pass through from raw
      "styles": {}       # pass through from raw
    }
    For each node in nodes.values(), extract document. Build tree via recursive _flatten_node(doc, max_depth=5, depth=0).
    Extract: absoluteBoundingBox (width, height), layoutMode, itemSpacing, paddingLeft/Right/Top/Bottom.
    For TEXT: characters, style (fontFamily, fontSize, fontWeight, lineHeightPx, color from fills).
    For RECTANGLE/ELLIPSE: fills (solid color, opacity), cornerRadius, strokes.
    For VECTOR/BOOLEAN_OPERATION: mark as icon (for Phase 2 SVG export in 02-04).
    Prune: omit verbose style objects, limit tree depth to 5, collapse redundant nesting.
    Handle images: identify fills with type IMAGE, note dimensions for placeholder.com fallback.
    Return dict (not Pydantic) — JSON-serializable for LLM.
  </action>
  <verify>Call transform_design_context with sample dict from figma.py import response. Output has frame, tree, tree nodes have layout/style/content where applicable. No crash on empty or malformed input.</verify>
  <done>transform_design_context produces compact structure for LLM.</done>
</task>

<task type="auto">
  <name>Task 2: Icon and image node identification</name>
  <files>backend/app/figma_context.py</files>
  <action>
    In _flatten_node, for nodes with type VECTOR or BOOLEAN_OPERATION: add "icon": True to output. These will be exported as SVG in 02-04.
    For nodes with fills containing type IMAGE: add "image": True, "width", "height" from absoluteBoundingBox. Enables placeholder.com fallback with correct sizing.
    Keep transformer pure — no side effects, no API calls. Just structure extraction.
  </action>
  <verify>Transform with frame containing VECTOR and IMAGE fill returns nodes with icon/image flags.</verify>
  <done>Icons and images identified for downstream export.</done>
</task>

</tasks>

<verification>
- transform_design_context(raw) returns valid dict
- Tree structure preserved, depth limited
- Layout, typography, colors, text extracted
- Empty/malformed input handled gracefully
</verification>

<success_criteria>
- Design context transformer ready for code generation endpoint
- Output suitable for LLM prompt (compact, structured)
</success_criteria>

<output>
After completion, create `.planning/phases/02-code-generation/02-02-SUMMARY.md`
</output>
