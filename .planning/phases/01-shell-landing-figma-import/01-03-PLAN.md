---
phase: 01-shell-landing-figma-import
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/config.py
  - backend/app/api/figma.py
  - backend/app/db.py
  - backend/app/main.py
  - PLAN.md
autonomous: true
requirements:
  - FIGMA-01
user_setup:
  - service: figma
    why: "OAuth for Figma file access"
    env_vars:
      - name: FIGMA_CLIENT_ID
        source: "Figma → Settings → OAuth 2 → Client ID"
      - name: FIGMA_CLIENT_SECRET
        source: "Figma → Settings → OAuth 2 → Client secret"
      - name: FIGMA_REDIRECT_URI
        source: "Must match exactly: https://api.yourapp.com/api/figma/oauth/callback (prod) or http://localhost:8000/api/figma/oauth/callback (dev)"
    dashboard_config:
      - task: "Create OAuth 2 app in Figma"
        location: "Figma → Settings → Apps & integrations → Develop"
      - task: "Add redirect URI"
        location: "Figma app settings — must match FIGMA_REDIRECT_URI exactly"

must_haves:
  truths:
    - User can complete Figma OAuth and return to app
    - Tokens stored server-side (Supabase or session)
    - OAuth callback exchanges code within 30 seconds
    - State param validated to prevent CSRF
  artifacts:
    - path: backend/app/api/figma.py
      provides: OAuth start + callback + status endpoints
      exports: ["GET /api/figma/oauth/start", "GET /api/figma/oauth/callback", "GET /api/figma/status"]
    - path: backend/app/config.py
      provides: FIGMA_CLIENT_ID, FIGMA_CLIENT_SECRET, FIGMA_REDIRECT_URI
      contains: "figma"
  key_links:
    - from: backend/app/api/figma.py
      to: backend/app/db.py
      via: Store tokens after exchange
      pattern: "store_figma_tokens|figma_tokens"
---

<objective>
Figma OAuth 2 backend: auth URL generation, callback handler, token exchange, token storage. User clicks Connect → redirects to Figma → consents → callback exchanges code → stores tokens → redirects to frontend.

Purpose: Enable user-scoped Figma API access for import. Tokens required for GET /v1/files/:key/nodes.
Output: GET /api/figma/oauth/start, GET /api/figma/oauth/callback, figma_tokens table, config vars.
</objective>

<execution_context>
@/Users/shubham/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shubham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-shell-landing-figma-import/01-RESEARCH.md
@backend/app/config.py
@backend/app/main.py
@backend/app/db.py
@docs/ERROR_CODES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config and token storage</name>
  <files>backend/app/config.py, backend/app/db.py, PLAN.md</files>
  <action>
    Add to Settings in config.py: figma_client_id (str, default ""), figma_client_secret (str, default ""), figma_redirect_uri (str, default "http://localhost:8000/api/figma/oauth/callback"). Add SQL to PLAN.md Part 5 for figma_tokens table: session_id (text, PK), access_token (text), refresh_token (text), expires_at (timestamptz), created_at (timestamptz). Add db.py functions: store_figma_tokens(session_id, access_token, refresh_token, expires_at), get_figma_tokens(session_id) -> Optional[dict]. Use get_supabase() singleton. Log on write/read failure per AGENTS.md. V0: session_id from cookie; if no session, generate UUID and set cookie in callback response. Document: user must run SQL in Supabase to create table.
  </action>
  <verify>Config loads FIGMA_* vars. db.store_figma_tokens and get_figma_tokens work (manual test or pytest).</verify>
  <done>Config has Figma vars. figma_tokens table schema in PLAN.md. db.py has store/get functions.</done>
</task>

<task type="auto">
  <name>Task 2: OAuth start and callback endpoints</name>
  <files>backend/app/api/figma.py, backend/app/main.py</files>
  <action>
    Create backend/app/api/figma.py. GET /api/figma/oauth/start: generate state (secrets.token_urlsafe(32)), store state in cookie or short-lived store (e.g. 5 min), redirect to Figma auth URL: https://www.figma.com/oauth?client_id=...&redirect_uri=...&scope=file_content:read,file_metadata:read&state=...&response_type=code. GET /api/figma/oauth/callback: validate state from query, extract code, POST to https://api.figma.com/v1/oauth/token with Basic base64(client_id:client_secret), body redirect_uri, code, grant_type=authorization_code. On success: store tokens via db.store_figma_tokens, set session cookie (httpOnly, secure in prod), redirect to frontend (e.g. NEXT_PUBLIC_APP_URL or config) with ?figma_connected=1. On failure: log with generate_error_code(), redirect to frontend with ?figma_error=1&error_code=BP-XXXXXX. Use httpx for token exchange. Exchange MUST complete within 30 seconds — do it immediately, no heavy DB before exchange. Register router in main.py.
  </action>
  <verify>GET /api/figma/oauth/start redirects to Figma. Callback with valid code exchanges and redirects. Invalid state returns error.</verify>
  <done>OAuth flow complete. Tokens stored. User returns to app with figma_connected=1.</done>
</task>

<task type="auto">
  <name>Task 3: GET /api/figma/status</name>
  <files>backend/app/api/figma.py</files>
  <action>
    Add GET /api/figma/status: read session_id from cookie, call db.get_figma_tokens(session_id). Return { "connected": true } if tokens exist and not expired, else { "connected": false }. No auth required — used by frontend to know if user has completed OAuth. Enables figmaConnected state on page load.
  </action>
  <verify>GET /api/figma/status with valid session returns connected: true. Without session or expired returns connected: false.</verify>
  <done>Status endpoint returns connection state for frontend.</done>
</task>

</tasks>

<verification>
- OAuth start redirects to Figma
- Callback exchanges code, stores tokens, redirects to frontend
- State validation prevents CSRF
- Error cases log and redirect with error_code
</verification>

<success_criteria>
- User completes Figma OAuth and returns to app
- Tokens stored in Supabase figma_tokens
- Error handling per docs/ERROR_CODES.md
</success_criteria>

<output>
After completion, create `.planning/phases/01-shell-landing-figma-import/01-03-SUMMARY.md`
</output>
