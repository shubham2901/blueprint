---
phase: 01-shell-landing-figma-import
plan: 04
type: execute
wave: 2
depends_on:
  - 01-03
files_modified:
  - backend/app/api/figma.py
  - backend/app/models.py
  - backend/app/main.py
autonomous: true
requirements:
  - FIGMA-02
  - FIGMA-03
  - FIGMA-04

must_haves:
  truths:
    - User can trigger import via POST with Figma frame URL
    - System returns design context (document subtree, components, styles)
    - Invalid URL returns friendly error with (Ref: BP-XXXXXX)
    - Validation warnings returned (e.g. no components, generic names) — never block
  artifacts:
    - path: backend/app/api/figma.py
      provides: POST /api/figma/import
      contains: "import"
    - path: backend/app/models.py
      provides: FigmaImportRequest, FigmaImportResponse (or equivalent)
      contains: "figma|Figma"
  key_links:
    - from: backend/app/api/figma.py
      to: backend/app/db.py
      via: get_figma_tokens(session_id)
      pattern: "get_figma_tokens"
    - from: backend/app/api/figma.py
      to: api.figma.com
      via: GET /v1/files/:key/nodes?ids=
      pattern: "api.figma.com|nodes"
---

<objective>
Figma import endpoint: parse URL, fetch design context via Figma REST API, validate/warn on structure, return document subtree + components + styles. Requires OAuth tokens from session.

Purpose: Enable single-frame import for Phase 1. Design context feeds code gen in Phase 2.
Output: POST /api/figma/import, URL parsing, httpx fetch, validation warnings.
</objective>

<execution_context>
@/Users/shubham/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shubham/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-shell-landing-figma-import/01-RESEARCH.md
@backend/app/api/figma.py
@backend/app/models.py
@docs/ERROR_CODES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: URL parsing and import endpoint</name>
  <files>backend/app/api/figma.py, backend/app/models.py</files>
  <action>
    Add parse_figma_url(url: str) -> tuple[str | None, str | None] using regex from 01-RESEARCH.md: extract file_key and node_id from https://figma.com/design/:file_key/:file_name?node-id=X-Y. Convert node_id hyphen to colon for API. Add Pydantic models: FigmaImportRequest(url: str), FigmaImportResponse(design_context: dict, warnings: list[str] = []). POST /api/figma/import: accept JSON body { url }, read session_id from cookie (same cookie set in OAuth callback), get tokens via db.get_figma_tokens(session_id). If no tokens: return 401 with friendly message + error_code. Parse URL; if invalid (file_key or node_id missing): return 400 with "That doesn't look like a valid Figma frame URL..." per docs/ERROR_CODES.md. Call GET https://api.figma.com/v1/files/{file_key}/nodes?ids={node_id} with Bearer token. On 403/404/rate limit: return friendly "We couldn't import that frame..." with error_code. On success: extract nodes, document, components, styles from response. Log per AGENTS.md.
  </action>
  <verify>POST /api/figma/import with valid URL and session returns design context. Invalid URL returns 400. No tokens returns 401.</verify>
  <done>Import endpoint parses URL, fetches nodes, returns design context. Errors use friendly messages + error_code.</done>
</task>

<task type="auto">
  <name>Task 2: Validation and warnings (FIGMA-04)</name>
  <files>backend/app/api/figma.py</files>
  <action>
    After fetching design context, run validation: check for components (document.components or similar in Figma response), Auto Layout (layoutMode in nodes), semantic/generic names (e.g. "Rectangle", "Frame" as generic). Append to warnings list: "No components found" if none, "Some layers may have generic names" if detected, "Auto Layout not detected" if missing (optional — Figma structure varies). Never block import — always return design_context. Include warnings in FigmaImportResponse. Phase 1 ends at returning design context; code gen is Phase 2.
  </action>
  <verify>Import with frame that has components returns empty warnings or specific warnings. Import with minimal frame returns appropriate warnings.</verify>
  <done>Validation runs; warnings returned. Import never blocked.</done>
</task>

</tasks>

<verification>
- Valid URL + tokens → 200 with design_context
- Invalid URL → 400 with friendly message + error_code
- No tokens → 401
- Figma API error → friendly message + error_code
- Warnings included when applicable
</verification>

<success_criteria>
- System returns design context for single frame
- URL validation, token check, API errors handled
- Warnings returned per FIGMA-04
</success_criteria>

<output>
After completion, create `.planning/phases/01-shell-landing-figma-import/01-04-SUMMARY.md`
</output>
